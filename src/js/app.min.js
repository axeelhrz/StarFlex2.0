// StarFlex 2.0 - JavaScript optimizado para rendimiento
(function(){
  'use strict';
  
  // Variables globales
  let isMenuOpen = false;
  let isMobileMenuOpen = false;
  let isFloatingMenuOpen = false;
  let isLanguageSwitcherOpen = false;
  let lastScrollY = 0;
  let isNavbarVisible = true;
  let isMobile = window.innerWidth <= 1023;
  let performanceMode = false;
  
  // Detección de dispositivo y capacidades
  function detectDeviceCapabilities() {
    isMobile = window.innerWidth <= 1023;
    const isReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    
    // Detectar dispositivos de baja potencia
    const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
    const isSlowConnection = connection && (
      connection.effectiveType === 'slow-2g' || 
      connection.effectiveType === '2g' || 
      connection.effectiveType === '3g'
    );
    const isLowEndDevice = navigator.hardwareConcurrency && navigator.hardwareConcurrency <= 4;
    
    performanceMode = isMobile && (isSlowConnection || isLowEndDevice || isReducedMotion);
    
    if (performanceMode) {
      document.body.classList.add('performance-mode');
    }
  }
  
  // Navegación móvil
  function initializeMobileNavigation() {
    const mobileNavToggle = document.getElementById('mobile-nav-toggle');
    const mobileNavMenu = document.getElementById('mobile-nav-menu');
    const mobileNavClose = document.getElementById('mobile-nav-close');
    const mobileNavOverlay = document.getElementById('mobile-nav-overlay');
    const mobileNavLinks = document.querySelectorAll('.mobile-nav__link');
    
    if (!mobileNavToggle || !mobileNavMenu) return;
    
    // Toggle hamburguesa móvil
    mobileNavToggle.addEventListener('click', (e) => {
      e.preventDefault();
      toggleMobileNavMenu();
    });
    
    // Botón cerrar móvil
    if (mobileNavClose) {
      mobileNavClose.addEventListener('click', (e) => {
        e.preventDefault();
        closeMobileNavMenu();
      });
    }
    
    // Overlay para cerrar
    if (mobileNavOverlay) {
      mobileNavOverlay.addEventListener('click', () => {
        closeMobileNavMenu();
      });
    }
    
    // Enlaces de navegación móvil
    mobileNavLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        
        const targetId = link.getAttribute('href');
        
        // Cerrar el menú
        if (isMobileMenuOpen) {
          closeMobileNavMenu();
        }
        
        // Buscar la sección objetivo
        const targetSection = document.querySelector(targetId);
        if (targetSection) {
          setTimeout(() => {
            smoothScrollToSection(targetSection);
          }, 100);
        }
      });
    });
    
    // Cerrar menú tocando fuera
    document.addEventListener('click', (e) => {
      if (isMobileMenuOpen && mobileNavMenu && !mobileNavMenu.contains(e.target) && !mobileNavToggle.contains(e.target)) {
        closeMobileNavMenu();
      }
    });
  }
  
  function toggleMobileNavMenu() {
    if (isMobileMenuOpen) {
      closeMobileNavMenu();
    } else {
      openMobileNavMenu();
    }
  }
  
  function openMobileNavMenu() {
    const mobileNavToggle = document.getElementById('mobile-nav-toggle');
    const mobileNavMenu = document.getElementById('mobile-nav-menu');
    const body = document.body;
    
    if (!mobileNavToggle || !mobileNavMenu) return;
    
    isMobileMenuOpen = true;
    
    mobileNavToggle.classList.add('active');
    mobileNavMenu.classList.add('active');
    body.classList.add('mobile-menu-open');
    
    mobileNavToggle.setAttribute('aria-expanded', 'true');
    mobileNavMenu.setAttribute('aria-hidden', 'false');
  }
  
  function closeMobileNavMenu() {
    const mobileNavToggle = document.getElementById('mobile-nav-toggle');
    const mobileNavMenu = document.getElementById('mobile-nav-menu');
    const body = document.body;
    
    if (!mobileNavToggle || !mobileNavMenu) return;
    
    isMobileMenuOpen = false;
    
    mobileNavToggle.classList.remove('active');
    mobileNavMenu.classList.remove('active');
    body.classList.remove('mobile-menu-open');
    
    mobileNavToggle.setAttribute('aria-expanded', 'false');
    mobileNavMenu.setAttribute('aria-hidden', 'true');
  }
  
  // Navegación general
  function smoothScrollToSection(targetSection) {
    if (!targetSection) return;
    
    const headerHeight = isMobile ? 70 : 80;
    const targetPosition = targetSection.offsetTop - headerHeight;
    
    if ('scrollBehavior' in document.documentElement.style && !performanceMode) {
      window.scrollTo({
        top: targetPosition,
        behavior: 'smooth'
      });
    } else {
      window.scrollTo(0, targetPosition);
    }
  }
  
  // Efectos de scroll
  function initializeScrollEffects() {
    let scrollTimeout;
    
    window.addEventListener('scroll', () => {
      if (scrollTimeout) return;
      
      scrollTimeout = setTimeout(() => {
        updateHeaderOnScroll();
        scrollTimeout = null;
      }, isMobile ? 50 : 25);
    }, { passive: true });
  }
  
  function updateHeaderOnScroll() {
    const header = document.getElementById('header');
    const mobileHeader = document.getElementById('mobile-header');
    const scrollY = window.scrollY;
    const threshold = isMobile ? 50 : 100;
    
    // Actualizar header móvil
    if (mobileHeader && isMobile) {
      if (scrollY > threshold) {
        mobileHeader.classList.add('scrolled');
      } else {
        mobileHeader.classList.remove('scrolled');
      }
      
      // Auto-hide navbar móvil
      if (scrollY > lastScrollY && scrollY > threshold && !isMobileMenuOpen) {
        if (isNavbarVisible) {
          mobileHeader.style.transform = 'translateY(-100%)';
          isNavbarVisible = false;
        }
      } else {
        if (!isNavbarVisible) {
          mobileHeader.style.transform = 'translateY(0)';
          isNavbarVisible = true;
        }
      }
    }
    
    // Actualizar header desktop
    if (header && !isMobile) {
      if (scrollY > threshold) {
        header.classList.add('scrolled');
      } else {
        header.classList.remove('scrolled');
      }
    }
    
    lastScrollY = scrollY;
  }
  
  // FAQ
  function initializeFAQ() {
    const faqItems = document.querySelectorAll('.faq__item');
    const searchInput = document.getElementById('faq-search');
    const noResults = document.getElementById('faq-no-results');
    
    faqItems.forEach(item => {
      const question = item.querySelector('.faq__question');
      const answer = item.querySelector('.faq__answer');
      
      if (question && answer) {
        question.addEventListener('click', () => {
          const isActive = item.classList.contains('active');
          
          faqItems.forEach(otherItem => {
            if (otherItem !== item) {
              otherItem.classList.remove('active');
              const otherAnswer = otherItem.querySelector('.faq__answer');
              const otherQuestion = otherItem.querySelector('.faq__question');
              if (otherAnswer) otherAnswer.classList.remove('active');
              if (otherQuestion) otherQuestion.setAttribute('aria-expanded', 'false');
            }
          });
          
          if (isActive) {
            item.classList.remove('active');
            answer.classList.remove('active');
            question.setAttribute('aria-expanded', 'false');
          } else {
            item.classList.add('active');
            answer.classList.add('active');
            question.setAttribute('aria-expanded', 'true');
          }
        });
      }
    });
    
    if (searchInput) {
      searchInput.addEventListener('input', debounce((e) => {
        const searchTerm = e.target.value.toLowerCase().trim();
        let visibleItems = 0;
        
        faqItems.forEach(item => {
          const questionText = item.querySelector('.faq__question-text');
          const answerText = item.querySelector('.faq__answer-text');
          
          if (questionText && answerText) {
            const questionContent = questionText.textContent.toLowerCase();
            const answerContent = answerText.textContent.toLowerCase();
            
            if (searchTerm === '' ||
                questionContent.includes(searchTerm) ||
                answerContent.includes(searchTerm)) {
              item.style.display = 'block';
              visibleItems++;
            } else {
              item.style.display = 'none';
              item.classList.remove('active');
              const answer = item.querySelector('.faq__answer');
              const question = item.querySelector('.faq__question');
              if (answer) answer.classList.remove('active');
              if (question) question.setAttribute('aria-expanded', 'false');
            }
          }
        });
        
        if (noResults) {
          if (visibleItems === 0 && searchTerm !== '') {
            noResults.classList.add('show');
          } else {
            noResults.classList.remove('show');
          }
        }
      }, isMobile ? 400 : 300));
    }
  }
  
  // Botón flotante
  function initializeFloatingWidget() {
    const floatingMainBtn = document.getElementById('floating-main-btn');
    const floatingMenu = document.getElementById('floating-menu');
    
    if (!floatingMainBtn || !floatingMenu) return;
    
    floatingMainBtn.addEventListener('click', () => {
      toggleFloatingMenu();
    });
    
    document.addEventListener('click', (e) => {
      const floatingWidget = document.getElementById('floating-widget');
      if (isFloatingMenuOpen && floatingWidget && !floatingWidget.contains(e.target)) {
        closeFloatingMenu();
      }
    });
  }
  
  function toggleFloatingMenu() {
    if (isFloatingMenuOpen) {
      closeFloatingMenu();
    } else {
      openFloatingMenu();
    }
  }
  
  function openFloatingMenu() {
    const floatingMainBtn = document.getElementById('floating-main-btn');
    const floatingMenu = document.getElementById('floating-menu');
    
    if (!floatingMainBtn || !floatingMenu) return;
    
    isFloatingMenuOpen = true;
    floatingMainBtn.classList.add('active');
    floatingMenu.classList.add('active');
    floatingMainBtn.setAttribute('aria-expanded', 'true');
  }
  
  function closeFloatingMenu() {
    const floatingMainBtn = document.getElementById('floating-main-btn');
    const floatingMenu = document.getElementById('floating-menu');
    
    if (!floatingMainBtn || !floatingMenu) return;
    
    isFloatingMenuOpen = false;
    floatingMainBtn.classList.remove('active');
    floatingMenu.classList.remove('active');
    floatingMainBtn.setAttribute('aria-expanded', 'false');
  }
  
  // Utilidades
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }
  
  // Inicialización
  function init() {
    detectDeviceCapabilities();
    
    if (isMobile) {
      initializeMobileNavigation();
    }
    
    initializeScrollEffects();
    initializeFAQ();
    initializeFloatingWidget();
    
    // Manejar resize
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        const newIsMobile = window.innerWidth <= 1023;
        if (newIsMobile !== isMobile) {
          isMobile = newIsMobile;
          detectDeviceCapabilities();
          
          // Cerrar menús abiertos al cambiar de dispositivo
          if (isMobileMenuOpen) {
            closeMobileNavMenu();
          }
          
          // Reinicializar navegación
          if (isMobile) {
            initializeMobileNavigation();
          }
        }
      }, 250);
    });
  }
  
  // Iniciar cuando el DOM esté listo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
